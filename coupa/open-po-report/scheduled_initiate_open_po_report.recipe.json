{
  "name": "Scheduled - Initiate Open PO Report",
  "description": "When there is a trigger event, do action",
  "version": 3,
  "private": true,
  "concurrency": 1,
  "code": {
    "number": 0,
    "provider": "clock",
    "name": "daily_task",
    "as": "e1f45444",
    "keyword": "trigger",
    "dynamicPickListSelection": {
    },
    "toggleCfg": {
      "sunday": true,
      "monday": true,
      "tuesday": true,
      "wednesday": true,
      "thursday": true,
      "friday": true,
      "saturday": true
    },
    "input": {
      "sunday": "false",
      "monday": "false",
      "tuesday": "true",
      "wednesday": "false",
      "thursday": "false",
      "friday": "false",
      "saturday": "false",
      "time_zone": "Eastern Time (US & Canada)",
      "hour": "1",
      "minute": "00"
    },
    "filter": {
      "conditions": [
        {
          "operand": "greater_than",
          "lhs": "=now.strftime(\"%e\").to_i",
          "rhs": "7"
        },
        {
          "operand": "less_than",
          "lhs": "=_('data.clock.e1f45444.scheduled_time').strftime(\"%e\").to_i",
          "rhs": "15"
        }
      ],
      "operand": "and",
      "type": "compound"
    },
    "block": [
      {
        "number": 1,
        "provider": "mysql",
        "name": "delete_rows",
        "as": "2bc0c2bd",
        "title": "Delete rows in coupa_open_po_report_po",
        "description": "Delete <span class=\"provider\">rows</span> in <span class=\"provider\">coupa_open_po_report_po</span> table in <span class=\"provider\">MySQL</span>",
        "keyword": "action",
        "dynamicPickListSelection": {
          "table": "coupa_open_po_report_po"
        },
        "toggleCfg": {
          "table": true
        },
        "input": {
          "table": "coupa_open_po_report_po",
          "where": "po_id IS NOT NULL"
        },
        "visible_config_fields": [
          "table",
          "where"
        ],
        "comment": "Since we are kicking off a new report, clean up the current POs and PO lines in the MySQL database",
        "uuid": "fd0b40b8-d97c-4429-952c-d6717e0ebd32"
      },
      {
        "number": 2,
        "provider": "mysql",
        "name": "delete_rows",
        "as": "d13b6e41",
        "title": "Delete rows in coupa_open_po_report_req_email",
        "description": "Delete <span class=\"provider\">rows</span> in <span class=\"provider\">coupa_open_po_report_req_email</span> table in <span class=\"provider\">MySQL</span>",
        "keyword": "action",
        "dynamicPickListSelection": {
          "table": "coupa_open_po_report_req_email"
        },
        "toggleCfg": {
          "table": true
        },
        "input": {
          "table": "coupa_open_po_report_req_email",
          "where": "email IS NOT NULL"
        },
        "visible_config_fields": [
          "table",
          "where"
        ],
        "comment": "Since we are kicking off a new report, clean up the associated emails with the Open PO Report",
        "uuid": "699abcab-d881-48b5-9b3e-5c8d28e98cbc"
      },
      {
        "number": 3,
        "provider": "lookup_table",
        "name": "search_entries",
        "as": "49f60dab",
        "title": null,
        "description": "\n      Search\n      <span class=\"provider\">entries</span>\n      in\n      <span class=\"provider\">COUPA_VARIABLES</span>\n      lookup table\n    ",
        "keyword": "action",
        "dynamicPickListSelection": {
          "lookup_table_id": "COUPA_VARIABLES"
        },
        "toggleCfg": {
        },
        "input": {
          "lookup_table_id": {
            "zip_name": "coupa_variables.lookup_table.json",
            "name": "COUPA_VARIABLES",
            "folder": ""
          },
          "parameters": {
            "col3": "status_variable"
          }
        },
        "extended_output_schema": [
          {
            "type": "array",
            "name": "entries",
            "label": "Entries",
            "of": "object",
            "properties": [
              {
                "control_type": "number",
                "label": "Entry ID",
                "parse_output": "integer_conversion",
                "type": "integer",
                "name": "id"
              },
              {
                "properties": [
                  {
                    "control_type": "text",
                    "label": "key",
                    "name": "col1",
                    "type": "string",
                    "sticky": true
                  },
                  {
                    "control_type": "text",
                    "label": "value",
                    "name": "col2",
                    "type": "string",
                    "sticky": true
                  },
                  {
                    "control_type": "text",
                    "label": "type",
                    "name": "col3",
                    "type": "string",
                    "sticky": true
                  }
                ],
                "label": "Entry",
                "type": "object",
                "name": "entry"
              }
            ]
          }
        ],
        "extended_input_schema": [
          {
            "type": "object",
            "name": "parameters",
            "label": "Search by",
            "hint": "Provide one or more entry fields to search the entry",
            "properties": [
              {
                "control_type": "text",
                "label": "key",
                "name": "col1",
                "type": "string",
                "sticky": true,
                "optional": true,
                "parent": "parameters"
              },
              {
                "control_type": "text",
                "label": "value",
                "name": "col2",
                "type": "string",
                "sticky": true,
                "optional": true,
                "parent": "parameters"
              },
              {
                "control_type": "text",
                "label": "type",
                "name": "col3",
                "type": "string",
                "sticky": true,
                "optional": true,
                "parent": "parameters"
              }
            ]
          }
        ],
        "visible_config_fields": [
          "lookup_table_id",
          "parameters",
          "parameters.col3"
        ],
        "hidden_config_fields": [
          "parameters.col1",
          "parameters.col2"
        ],
        "comment": "Get the Entry IDs for the status variables",
        "uuid": "fc2091ab-fd05-45c6-b4e2-bae92ea7d095"
      },
      {
        "number": 4,
        "as": "0fe44e62",
        "keyword": "foreach",
        "dynamicPickListSelection": {
        },
        "toggleCfg": {
        },
        "clear_scope": "true",
        "input": {
        },
        "block": [
          {
            "number": 5,
            "provider": "lookup_table",
            "name": "update_entry",
            "as": "a8a47855",
            "title": null,
            "description": "\n      Update\n      <span class=\"provider\">entry</span>\n      in\n      <span class=\"provider\">COUPA_VARIABLES</span>\n      lookup table\n    ",
            "keyword": "action",
            "dynamicPickListSelection": {
              "lookup_table_id": "COUPA_VARIABLES"
            },
            "toggleCfg": {
              "ignore_not_found": true
            },
            "input": {
              "ignore_not_found": "false",
              "lookup_table_id": {
                "zip_name": "coupa_variables.lookup_table.json",
                "name": "COUPA_VARIABLES",
                "folder": ""
              },
              "id": "#{_('data.foreach.0fe44e62.id')}",
              "parameters": {
                "col2": "pending"
              }
            },
            "extended_output_schema": [
              {
                "type": "integer",
                "name": "id",
                "control_type": "number",
                "label": "Entry ID",
                "parse_output": "integer_conversion"
              },
              {
                "type": "object",
                "name": "entry",
                "label": "Entry",
                "properties": [
                  {
                    "control_type": "text",
                    "label": "key",
                    "name": "col1",
                    "type": "string",
                    "sticky": true
                  },
                  {
                    "control_type": "text",
                    "label": "value",
                    "name": "col2",
                    "type": "string",
                    "sticky": true
                  },
                  {
                    "control_type": "text",
                    "label": "type",
                    "name": "col3",
                    "type": "string",
                    "sticky": true
                  }
                ]
              }
            ],
            "extended_input_schema": [
              {
                "type": "object",
                "name": "parameters",
                "label": "Entry fields",
                "hint": "Fill the fields you want to update",
                "properties": [
                  {
                    "control_type": "text",
                    "label": "key",
                    "name": "col1",
                    "type": "string",
                    "sticky": true,
                    "optional": true
                  },
                  {
                    "control_type": "text",
                    "label": "value",
                    "name": "col2",
                    "type": "string",
                    "sticky": true,
                    "optional": true
                  },
                  {
                    "control_type": "text",
                    "label": "type",
                    "name": "col3",
                    "type": "string",
                    "sticky": true,
                    "optional": true
                  }
                ]
              }
            ],
            "visible_config_fields": [
              "lookup_table_id",
              "id",
              "ignore_not_found",
              "parameters.col2",
              "parameters"
            ],
            "hidden_config_fields": [
              "parameters.col1",
              "parameters.col3"
            ],
            "uuid": "68e97a8e-dee8-48e4-ad10-60eebee34cbb"
          }
        ],
        "source": "#{_('data.lookup_table.49f60dab.entries')}",
        "comment": "Set all the status variables to \"pending\"",
        "uuid": "2f4bc31f-cb5a-4df0-96da-1eddf4e459b2"
      },
      {
        "number": 6,
        "provider": "workato_pub_sub",
        "name": "publish_to_topic",
        "as": "2cf31b1b",
        "title": null,
        "description": "Publish <span class=\"provider\">message</span> to <span class=\"provider\">Coupa Requests</span> PubSub topic",
        "keyword": "action",
        "dynamicPickListSelection": {
          "topic_id": "Coupa Requests"
        },
        "toggleCfg": {
        },
        "input": {
          "topic_id": {
            "zip_name": "coupa_requests.topic.json",
            "name": "Coupa Requests",
            "folder": ""
          },
          "message": {
            "type": "fetch-open-pos",
            "fetch_open_pos_offset": "0",
            "fetch_open_pos_thread": "1"
          }
        },
        "extended_input_schema": [
          {
            "type": "object",
            "name": "message",
            "label": "Message",
            "properties": [
              {
                "control_type": "text",
                "label": "Type",
                "name": "type",
                "type": "string",
                "optional": false,
                "hint": "fetch-open-pos, fetch-po-req, fetch-po-lines"
              },
              {
                "control_type": "integer",
                "label": "fetch-open-pos: Offset",
                "parse_output": "integer_conversion",
                "name": "fetch_open_pos_offset",
                "type": "integer",
                "optional": true,
                "hint": "offset for the next 50 POs to fetch"
              },
              {
                "control_type": "integer",
                "label": "fetch-open-pos: Thread Number",
                "parse_output": "float_conversion",
                "name": "fetch_open_pos_thread",
                "type": "integer",
                "optional": true,
                "hint": "identifier for the thread so we can track its status"
              },
              {
                "control_type": "integer",
                "label": "fetch-po-req: Purchase Order ID",
                "parse_output": "float_conversion",
                "name": "fetch_po_req_po_id",
                "type": "integer",
                "optional": true,
                "hint": "ID of the PO related to the Requisition"
              },
              {
                "control_type": "integer",
                "label": "fetch-po-req: Requisition ID",
                "parse_output": "integer_conversion",
                "name": "fetch_po_req_req_id",
                "type": "integer",
                "optional": true,
                "hint": "ID of the Requisition Header to fetch"
              },
              {
                "control_type": "integer",
                "label": "fetch-po-lines: Purchase Order ID",
                "parse_output": "integer_conversion",
                "name": "fetch_po_lines_po_id",
                "type": "integer",
                "optional": true,
                "hint": "ID of the Purchase Order related to the PO lines"
              }
            ]
          }
        ],
        "comment": "Add a request to fetch the open pos, specify the offset of 0 since we will have 5 threads pulling in open pos (the other threads will be offset by 50, 100, 150, and 200 since each request can fetch 50 POs)",
        "uuid": "4af6342c-1521-4ae8-9e10-3420553147ad"
      },
      {
        "number": 7,
        "provider": "workato_pub_sub",
        "name": "publish_to_topic",
        "as": "5e8c6ec8",
        "title": null,
        "description": "Publish <span class=\"provider\">message</span> to <span class=\"provider\">Coupa Requests</span> PubSub topic",
        "keyword": "action",
        "dynamicPickListSelection": {
          "topic_id": "Coupa Requests"
        },
        "toggleCfg": {
        },
        "input": {
          "topic_id": {
            "zip_name": "coupa_requests.topic.json",
            "name": "Coupa Requests",
            "folder": ""
          },
          "message": {
            "type": "fetch-open-pos",
            "fetch_open_pos_offset": "50",
            "fetch_open_pos_thread": "2"
          }
        },
        "extended_input_schema": [
          {
            "type": "object",
            "name": "message",
            "label": "Message",
            "properties": [
              {
                "control_type": "text",
                "label": "Type",
                "name": "type",
                "type": "string",
                "optional": false,
                "hint": "fetch-open-pos, fetch-po-req, fetch-po-lines"
              },
              {
                "control_type": "integer",
                "label": "fetch-open-pos: Offset",
                "parse_output": "integer_conversion",
                "name": "fetch_open_pos_offset",
                "type": "integer",
                "optional": true,
                "hint": "offset for the next 50 POs to fetch"
              },
              {
                "control_type": "integer",
                "label": "fetch-open-pos: Thread Number",
                "parse_output": "float_conversion",
                "name": "fetch_open_pos_thread",
                "type": "integer",
                "optional": true,
                "hint": "identifier for the thread so we can track its status"
              },
              {
                "control_type": "integer",
                "label": "fetch-po-req: Purchase Order ID",
                "parse_output": "float_conversion",
                "name": "fetch_po_req_po_id",
                "type": "integer",
                "optional": true,
                "hint": "ID of the PO related to the Requisition"
              },
              {
                "control_type": "integer",
                "label": "fetch-po-req: Requisition ID",
                "parse_output": "integer_conversion",
                "name": "fetch_po_req_req_id",
                "type": "integer",
                "optional": true,
                "hint": "ID of the Requisition Header to fetch"
              },
              {
                "control_type": "integer",
                "label": "fetch-po-lines: Purchase Order ID",
                "parse_output": "integer_conversion",
                "name": "fetch_po_lines_po_id",
                "type": "integer",
                "optional": true,
                "hint": "ID of the Purchase Order related to the PO lines"
              }
            ]
          }
        ],
        "comment": "Thread 2 - start with offset 50",
        "uuid": "0582af2a-74d6-4eb7-8dc6-371f6cad38ba"
      },
      {
        "number": 8,
        "provider": "workato_pub_sub",
        "name": "publish_to_topic",
        "as": "55d840da",
        "title": null,
        "description": "Publish <span class=\"provider\">message</span> to <span class=\"provider\">Coupa Requests</span> PubSub topic",
        "keyword": "action",
        "dynamicPickListSelection": {
          "topic_id": "Coupa Requests"
        },
        "toggleCfg": {
        },
        "input": {
          "topic_id": {
            "zip_name": "coupa_requests.topic.json",
            "name": "Coupa Requests",
            "folder": ""
          },
          "message": {
            "type": "fetch-open-pos",
            "fetch_open_pos_offset": "100",
            "fetch_open_pos_thread": "3"
          }
        },
        "extended_input_schema": [
          {
            "type": "object",
            "name": "message",
            "label": "Message",
            "properties": [
              {
                "control_type": "text",
                "label": "Type",
                "name": "type",
                "type": "string",
                "optional": false,
                "hint": "fetch-open-pos, fetch-po-req, fetch-po-lines"
              },
              {
                "control_type": "integer",
                "label": "fetch-open-pos: Offset",
                "parse_output": "integer_conversion",
                "name": "fetch_open_pos_offset",
                "type": "integer",
                "optional": true,
                "hint": "offset for the next 50 POs to fetch"
              },
              {
                "control_type": "integer",
                "label": "fetch-open-pos: Thread Number",
                "parse_output": "float_conversion",
                "name": "fetch_open_pos_thread",
                "type": "integer",
                "optional": true,
                "hint": "identifier for the thread so we can track its status"
              },
              {
                "control_type": "integer",
                "label": "fetch-po-req: Purchase Order ID",
                "parse_output": "float_conversion",
                "name": "fetch_po_req_po_id",
                "type": "integer",
                "optional": true,
                "hint": "ID of the PO related to the Requisition"
              },
              {
                "control_type": "integer",
                "label": "fetch-po-req: Requisition ID",
                "parse_output": "integer_conversion",
                "name": "fetch_po_req_req_id",
                "type": "integer",
                "optional": true,
                "hint": "ID of the Requisition Header to fetch"
              },
              {
                "control_type": "integer",
                "label": "fetch-po-lines: Purchase Order ID",
                "parse_output": "integer_conversion",
                "name": "fetch_po_lines_po_id",
                "type": "integer",
                "optional": true,
                "hint": "ID of the Purchase Order related to the PO lines"
              }
            ]
          }
        ],
        "comment": "Thread 3 - start with offset 100",
        "uuid": "cf47b6be-f451-424e-acd4-96119b3ca4d2"
      },
      {
        "number": 9,
        "provider": "workato_pub_sub",
        "name": "publish_to_topic",
        "as": "c1af4c69",
        "title": null,
        "description": "Publish <span class=\"provider\">message</span> to <span class=\"provider\">Coupa Requests</span> PubSub topic",
        "keyword": "action",
        "dynamicPickListSelection": {
          "topic_id": "Coupa Requests"
        },
        "toggleCfg": {
        },
        "input": {
          "topic_id": {
            "zip_name": "coupa_requests.topic.json",
            "name": "Coupa Requests",
            "folder": ""
          },
          "message": {
            "type": "fetch-open-pos",
            "fetch_open_pos_offset": "150",
            "fetch_open_pos_thread": "4"
          }
        },
        "extended_input_schema": [
          {
            "type": "object",
            "name": "message",
            "label": "Message",
            "properties": [
              {
                "control_type": "text",
                "label": "Type",
                "name": "type",
                "type": "string",
                "optional": false,
                "hint": "fetch-open-pos, fetch-po-req, fetch-po-lines"
              },
              {
                "control_type": "integer",
                "label": "fetch-open-pos: Offset",
                "parse_output": "integer_conversion",
                "name": "fetch_open_pos_offset",
                "type": "integer",
                "optional": true,
                "hint": "offset for the next 50 POs to fetch"
              },
              {
                "control_type": "integer",
                "label": "fetch-open-pos: Thread Number",
                "parse_output": "float_conversion",
                "name": "fetch_open_pos_thread",
                "type": "integer",
                "optional": true,
                "hint": "identifier for the thread so we can track its status"
              },
              {
                "control_type": "integer",
                "label": "fetch-po-req: Purchase Order ID",
                "parse_output": "float_conversion",
                "name": "fetch_po_req_po_id",
                "type": "integer",
                "optional": true,
                "hint": "ID of the PO related to the Requisition"
              },
              {
                "control_type": "integer",
                "label": "fetch-po-req: Requisition ID",
                "parse_output": "integer_conversion",
                "name": "fetch_po_req_req_id",
                "type": "integer",
                "optional": true,
                "hint": "ID of the Requisition Header to fetch"
              },
              {
                "control_type": "integer",
                "label": "fetch-po-lines: Purchase Order ID",
                "parse_output": "integer_conversion",
                "name": "fetch_po_lines_po_id",
                "type": "integer",
                "optional": true,
                "hint": "ID of the Purchase Order related to the PO lines"
              }
            ]
          }
        ],
        "comment": "Thread 4 - start with offset 150",
        "uuid": "0a83d0d0-df49-4302-b553-e8bfa70d74ac"
      },
      {
        "number": 10,
        "provider": "workato_pub_sub",
        "name": "publish_to_topic",
        "as": "72a8af76",
        "title": null,
        "description": "Publish <span class=\"provider\">message</span> to <span class=\"provider\">Coupa Requests</span> PubSub topic",
        "keyword": "action",
        "dynamicPickListSelection": {
          "topic_id": "Coupa Requests"
        },
        "toggleCfg": {
        },
        "input": {
          "topic_id": {
            "zip_name": "coupa_requests.topic.json",
            "name": "Coupa Requests",
            "folder": ""
          },
          "message": {
            "type": "fetch-open-pos",
            "fetch_open_pos_offset": "200",
            "fetch_open_pos_thread": "5"
          }
        },
        "extended_input_schema": [
          {
            "type": "object",
            "name": "message",
            "label": "Message",
            "properties": [
              {
                "control_type": "text",
                "label": "Type",
                "name": "type",
                "type": "string",
                "optional": false,
                "hint": "fetch-open-pos, fetch-po-req, fetch-po-lines"
              },
              {
                "control_type": "integer",
                "label": "fetch-open-pos: Offset",
                "parse_output": "integer_conversion",
                "name": "fetch_open_pos_offset",
                "type": "integer",
                "optional": true,
                "hint": "offset for the next 50 POs to fetch"
              },
              {
                "control_type": "integer",
                "label": "fetch-open-pos: Thread Number",
                "parse_output": "float_conversion",
                "name": "fetch_open_pos_thread",
                "type": "integer",
                "optional": true,
                "hint": "identifier for the thread so we can track its status"
              },
              {
                "control_type": "integer",
                "label": "fetch-po-req: Purchase Order ID",
                "parse_output": "float_conversion",
                "name": "fetch_po_req_po_id",
                "type": "integer",
                "optional": true,
                "hint": "ID of the PO related to the Requisition"
              },
              {
                "control_type": "integer",
                "label": "fetch-po-req: Requisition ID",
                "parse_output": "integer_conversion",
                "name": "fetch_po_req_req_id",
                "type": "integer",
                "optional": true,
                "hint": "ID of the Requisition Header to fetch"
              },
              {
                "control_type": "integer",
                "label": "fetch-po-lines: Purchase Order ID",
                "parse_output": "integer_conversion",
                "name": "fetch_po_lines_po_id",
                "type": "integer",
                "optional": true,
                "hint": "ID of the Purchase Order related to the PO lines"
              }
            ]
          }
        ],
        "comment": "Thread 5 - start with offset 200",
        "uuid": "61a7a31b-d682-488d-8a03-0909870881e8"
      },
      {
        "number": 11,
        "provider": "workato_app",
        "name": "start_recipe",
        "as": "429853be",
        "keyword": "action",
        "dynamicPickListSelection": {
          "recipe_id": "Scheduled - Monitor Coupa Data Fetch and Send PO Report Emails"
        },
        "toggleCfg": {
          "recipe_id": false
        },
        "input": {
          "recipe_id": "=lookup(\"COUPA_VARIABLES\", key: \"recipe.send_open_po_report\")[\"value\"]"
        },
        "comment": "Start monitoring the data fetch and send the emails when all data has been transferred.",
        "uuid": "194bcb26-4941-413d-ac9c-1248f0a10bd2"
      },
      {
        "number": 12,
        "provider": "workato_app",
        "name": "start_recipe",
        "as": "4179baf1",
        "keyword": "action",
        "dynamicPickListSelection": {
          "recipe_id": "Scheduled - Monitor Send PO Report Status and Send Summary Email"
        },
        "toggleCfg": {
          "recipe_id": false
        },
        "input": {
          "recipe_id": "=lookup(\"COUPA_VARIABLES\", key: \"recipe.send_po_summary_email\")[\"value\"]"
        },
        "comment": "Start monitoring the Open PO Report sending status and send a summary email once it is finished.",
        "uuid": "98227ae2-8d9a-45cf-8999-fa8c3de8f6f1"
      }
    ],
    "comment": "Run the open PO report on the second Tuesday of every month",
    "uuid": "eb148923-4f57-49e8-9a7a-5f4191aca228"
  },
  "config": [
    {
      "keyword": "application",
      "provider": "clock",
      "skip_validation": false,
      "account_id": null
    },
    {
      "keyword": "application",
      "provider": "workato_pub_sub",
      "skip_validation": false,
      "account_id": null
    },
    {
      "keyword": "application",
      "provider": "mysql",
      "account_id": {
        "zip_name": "resources/mysql.connection.json",
        "name": "MySQL",
        "folder": "resources"
      },
      "skip_validation": false
    },
    {
      "keyword": "application",
      "provider": "lookup_table",
      "skip_validation": false,
      "account_id": null
    },
    {
      "keyword": "application",
      "provider": "workato_app",
      "account_id": {
        "zip_name": "resources/recipeops.connection.json",
        "name": "RecipeOps",
        "folder": "resources"
      },
      "skip_validation": false
    }
  ]
}